<!DOCTYPE html>
<html lang="th">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Smart Data Table</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link
        href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600&family=Sarabun:wght@300;400;500;600&display=swap"
        rel="stylesheet">
    <style>
:root {
    /* Dark Mode Theme (Default) */
    --primary-color: #6366f1;
    --primary-hover: #818cf8;
    --bg-color: #111827;
    --card-bg: #1f2937;
    --text-main: #f9fafb;
    --text-secondary: #9ca3af;
    --border-color: #374151;
    --danger-color: #f87171;
    --date-header-bg: #2d3748;

    /* Font Sizes (Dynamic) */
    --font-size-base: 0.9rem;
    --font-size-sm: 0.8rem;
    --font-size-lg: 1.05rem;
    --font-size-header: 1.3rem;

    --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.3);
    --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.4), 0 2px 4px -1px rgba(0, 0, 0, 0.2);
    --radius: 8px;
}

/* Light Mode */
body.light-mode {
    --bg-color: #f3f4f6;
    --card-bg: #ffffff;
    --text-main: #111827;
    --text-secondary: #6b7280;
    --border-color: #d1d5db;
    --date-header-bg: #e5e7eb;
    --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
    --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
}

* {
    margin: 0;
    padding: 0;
    box-sizing: border-box;
    font-family: 'Inter', 'Sarabun', sans-serif;
}

body {
    background-color: var(--bg-color);
    color: var(--text-main);
    min-height: 100vh;
    padding: 20px;
    transition: background-color 0.3s ease, color 0.3s ease;
}

.app-container {
    width: 100%;
    max-width: 100%;
    background: var(--card-bg);
    border-radius: var(--radius);
    box-shadow: var(--shadow-md);
    padding: 20px;
    display: flex;
    flex-direction: column;
    gap: 16px;
    transition: background-color 0.3s ease, box-shadow 0.3s ease;
}

header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding-bottom: 16px;
    border-bottom: 1px solid var(--border-color);
}

.header-content h1 {
    font-size: var(--font-size-header);
    font-weight: 600;
    color: var(--text-main);
    display: flex;
    align-items: center;
    gap: 8px;
}

.header-content h1 i {
    color: var(--primary-color);
}

.header-content p {
    color: var(--text-secondary);
    font-size: calc(var(--font-size-sm) * 1.1);
    margin-top: 2px;
}

.header-actions {
    display: flex;
    gap: 10px;
    align-items: center;
    flex-wrap: wrap;
}

/* Board Layout - Horizontal Scroll */
.board-wrapper {
    display: flex;
    gap: 20px;
    overflow-x: auto;
    padding: 20px 0;
    align-items: flex-start;
}

.board-wrapper::-webkit-scrollbar {
    height: 8px;
}

.board-wrapper::-webkit-scrollbar-track {
    background: var(--bg-color);
    border-radius: 4px;
}

.board-wrapper::-webkit-scrollbar-thumb {
    background: var(--border-color);
    border-radius: 4px;
}

.board-wrapper::-webkit-scrollbar-thumb:hover {
    background: #4b5563;
}

/* Table Card */
.table-card {
    min-width: 700px;
    max-width: 800px;
    flex-shrink: 0;
    background: var(--bg-color);
    border-radius: 12px;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
    display: flex;
    flex-direction: column;
    border: 1px solid var(--border-color);
    transition: background-color 0.3s ease, border-color 0.3s ease;
}

.table-card-header {
    padding: 16px;
    border-bottom: 1px solid var(--border-color);
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.table-card-header h3 {
    font-size: var(--font-size-lg);
    font-weight: 600;
    color: var(--text-main);
    outline: none;
    padding: 4px 8px;
    border-radius: 4px;
    transition: background-color 0.2s;
}

.table-card-header h3:focus {
    background-color: var(--card-bg);
    box-shadow: 0 0 0 2px var(--primary-color);
}

.table-card-body {
    flex: 1;
    overflow-y: auto;
    max-height: 600px;
}

.table-card-footer {
    padding: 12px 16px;
    border-top: 1px solid var(--border-color);
}

.card-add-row {
    display: flex;
    gap: 8px;
    align-items: center;
}

.bulk-add-input {
    width: 60px;
    background: var(--card-bg);
    border: 1px solid var(--border-color);
    color: var(--text-main);
    padding: 6px 8px;
    border-radius: 6px;
    font-size: var(--font-size-sm);
    text-align: center;
}

.btn-icon-sm {
    background: none;
    border: none;
    color: var(--text-secondary);
    cursor: pointer;
    padding: 4px 8px;
    border-radius: 4px;
    transition: all 0.2s;
}

.btn-icon-sm:hover {
    background: var(--border-color);
    color: var(--danger-color);
}

.date-input {
    background: var(--card-bg);
    border: 1px solid var(--border-color);
    color: var(--text-main);
    padding: 6px 10px;
    border-radius: 6px;
    font-size: var(--font-size-base);
    flex: 1;
}

.btn-primary {
    background-color: var(--primary-color);
    color: white;
    border: none;
    padding: 6px 12px;
    border-radius: 6px;
    font-weight: 500;
    cursor: pointer;
    transition: all 0.2s ease;
    display: flex;
    align-items: center;
    gap: 6px;
    font-size: var(--font-size-base);
}

.btn-secondary {
    background-color: var(--bg-color);
    color: var(--text-secondary);
    border: 1px solid var(--border-color);
    padding: 6px 10px;
    border-radius: 6px;
    cursor: pointer;
    transition: all 0.2s;
    display: flex;
    align-items: center;
    gap: 6px;
    font-size: var(--font-size-base);
}

.btn-secondary:hover {
    background-color: var(--border-color);
    color: var(--text-main);
}

.btn-primary:hover {
    background-color: var(--primary-hover);
}

.btn-sm {
    padding: 4px 10px;
    font-size: var(--font-size-sm);
}

/* Table with continuous borders */
table {
    width: 100%;
    border-collapse: collapse;
    text-align: left;
}

thead {
    background-color: var(--card-bg);
}

th {
    padding: 10px 12px;
    font-size: var(--font-size-sm);
    font-weight: 600;
    color: var(--text-secondary);
    text-transform: uppercase;
    letter-spacing: 0.05em;
    border: 1px solid var(--border-color);
    background-color: var(--card-bg);
}

td {
    padding: 10px 12px;
    border: 1px solid var(--border-color);
    vertical-align: middle;
    font-size: var(--font-size-base);
    color: var(--text-main);
    transition: background-color 0.2s;
}

/* Date Header Row */
.date-header {
    background-color: var(--date-header-bg) !important;
    font-weight: 600;
    font-size: var(--font-size-base);
    color: var(--text-main);
    padding: 10px 12px;
}

/* Editable Cells */
.editable {
    outline: none;
    padding: 4px 8px;
    border-radius: 4px;
    transition: all 0.2s;
    min-height: 24px;
}

.editable:focus {
    background-color: var(--card-bg);
    box-shadow: 0 0 0 2px var(--primary-color);
}

/* Status Select */
.status-select {
    padding: 6px 12px;
    border-radius: 8px;
    border: 1px solid transparent;
    font-size: var(--font-size-base);
    font-weight: 500;
    cursor: pointer;
    transition: all 0.2s;
    min-width: 120px;
    max-width: 100%;
}

.status-select:focus {
    outline: none;
    box-shadow: 0 0 0 2px rgba(99, 102, 241, 0.3);
}

/* Delete Button */
.btn-delete {
    background: none;
    border: none;
    color: var(--text-secondary);
    cursor: pointer;
    padding: 6px;
    border-radius: 4px;
    transition: all 0.2s;
    display: flex;
    align-items: center;
    justify-content: center;
}

.btn-delete:hover {
    background-color: rgba(248, 113, 113, 0.1);
    color: var(--danger-color);
}

.hidden {
    display: none !important;
}

/* Empty State */
.empty-state {
    text-align: center;
    padding: 60px 20px;
    color: var(--text-secondary);
}

.empty-state i {
    font-size: 3rem;
    margin-bottom: 16px;
    opacity: 0.5;
}

.empty-state p {
    font-size: calc(var(--font-size-base) * 1.1);
}

/* Modal */
.modal {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.7);
    display: flex;
    justify-content: center;
    align-items: center;
    z-index: 1000;
    backdrop-filter: blur(2px);
}

.modal-content {
    background: var(--card-bg);
    border-radius: var(--radius);
    width: 90%;
    max-width: 500px;
    box-shadow: var(--shadow-md);
    border: 1px solid var(--border-color);
    transition: background-color 0.3s ease;
}

.modal-header {
    padding: 16px;
    border-bottom: 1px solid var(--border-color);
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.modal-header h2 {
    font-size: var(--font-size-lg);
    color: var(--text-main);
}

.modal-body {
    padding: 16px;
}

.btn-icon {
    background: none;
    border: none;
    color: var(--text-secondary);
    cursor: pointer;
    font-size: var(--font-size-lg);
    padding: 4px;
    border-radius: 4px;
    transition: all 0.2s;
}

.btn-icon:hover {
    background: var(--border-color);
    color: var(--text-main);
}

/* Status Management */
.status-list {
    display: flex;
    flex-direction: column;
    gap: 8px;
    margin-bottom: 16px;
}

.status-item {
    display: flex;
    align-items: center;
    gap: 8px;
    padding: 8px;
    background: var(--bg-color);
    border-radius: 6px;
}

.status-color-preview {
    width: 16px;
    height: 16px;
    border-radius: 50%;
    flex-shrink: 0;
}

.add-status-form {
    display: flex;
    gap: 8px;
    align-items: center;
}

.input-sm {
    flex: 1;
    background: var(--bg-color);
    border: 1px solid var(--border-color);
    color: var(--text-main);
    padding: 6px 10px;
    border-radius: 6px;
    font-size: var(--font-size-base);
}

.input-full {
    width: 100%;
    background: var(--bg-color);
    border: 1px solid var(--border-color);
    color: var(--text-main);
    padding: 8px 12px;
    border-radius: 6px;
    font-size: calc(var(--font-size-base) * 1.1);
}

.color-input {
    width: 40px;
    height: 32px;
    border: 1px solid var(--border-color);
    border-radius: 6px;
    cursor: pointer;
    background: var(--bg-color);
}

.form-group {
    margin-bottom: 16px;
}

.form-group label {
    display: block;
    margin-bottom: 8px;
    font-size: var(--font-size-base);
    color: var(--text-secondary);
    font-weight: 500;
}

.form-actions {
    display: flex;
    gap: 8px;
}

.full-width {
    width: 100%;
}

/* Color Picker Menu Enhancement */
.color-picker-tabs {
    display: flex;
    gap: 8px;
    margin-bottom: 12px;
    border-bottom: 1px solid var(--border-color);
}

.color-tab {
    flex: 1;
    padding: 8px;
    background: none;
    border: none;
    border-bottom: 2px solid transparent;
    color: var(--text-secondary);
    cursor: pointer;
    font-size: var(--font-size-sm);
    transition: all 0.2s;
}

.color-tab.active {
    color: var(--primary-color);
    border-bottom-color: var(--primary-color);
}

.color-tab:hover {
    color: var(--text-main);
}
</style>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>

<body>
    <div class="app-container">
        <header>
            <div class="header-content">
                <h1><i class="fa-solid fa-table-cells"></i> ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</h1>
                <p>‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÅ‡∏ö‡∏ö‡∏ï‡∏≤‡∏£‡∏≤‡∏á</p>
            </div>
            <div class="header-actions">
                <button id="fontDecreaseBtn" class="btn-secondary" title="‡∏•‡∏î‡∏Ç‡∏ô‡∏≤‡∏î‡∏≠‡∏±‡∏Å‡∏©‡∏£">
                    <i class="fa-solid fa-font"></i><i class="fa-solid fa-minus"></i>
                </button>
                <button id="fontIncreaseBtn" class="btn-secondary" title="‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ç‡∏ô‡∏≤‡∏î‡∏≠‡∏±‡∏Å‡∏©‡∏£">
                    <i class="fa-solid fa-font"></i><i class="fa-solid fa-plus"></i>
                </button>
                <button id="themeToggleBtn" class="btn-secondary" title="‡∏™‡∏•‡∏±‡∏ö‡πÇ‡∏´‡∏°‡∏î‡∏™‡∏µ">
                    <i class="fa-solid fa-circle-half-stroke"></i>
                </button>
                <button id="toggleTimestampBtn" class="btn-secondary">
                    <i class="fa-regular fa-clock"></i>
                    <span id="timestampStatus">‡∏õ‡∏¥‡∏î</span>
                </button>
                <button id="saveJsonBtn" class="btn-secondary" title="‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å JSON">
                    <i class="fa-solid fa-floppy-disk"></i> Save
                </button>
                <button id="exportExcelBtn" class="btn-secondary" title="‡∏™‡πà‡∏á‡∏≠‡∏≠‡∏Å Excel">
                    <i class="fa-solid fa-file-excel"></i> Excel
                </button>
                <button id="undoBtn" class="btn-secondary" title="‡∏¢‡πâ‡∏≠‡∏ô‡∏Å‡∏•‡∏±‡∏ö">
                    <i class="fa-solid fa-rotate-left"></i>
                </button>
                <button id="settingsBtn" class="btn-secondary" title="‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤">
                    <i class="fa-solid fa-gear"></i>
                </button>
                <button id="showHiddenBtn" class="btn-secondary" title="‡πÅ‡∏™‡∏î‡∏á‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏ó‡∏µ‡πà‡∏ã‡πà‡∏≠‡∏ô">
                    <i class="fa-solid fa-eye"></i>
                </button>
                <button id="addTableBtn" class="btn-primary">
                    <i class="fa-solid fa-plus"></i> ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ï‡∏≤‡∏£‡∏≤‡∏á
                </button>
            </div>
        </header>

        <main>
            <div id="emptyBoardState" class="empty-state hidden">
                <i class="fa-solid fa-table-columns"></i>
                <p>‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• ‡∏Å‡∏î‡∏õ‡∏∏‡πà‡∏° "‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ï‡∏≤‡∏£‡∏≤‡∏á" ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô</p>
            </div>
            <div id="boardWrapper" class="board-wrapper">
                <!-- Table cards will be generated here by JavaScript -->
            </div>
        </main>
    </div>

    <!-- Settings Modal -->
    <div id="settingsModal" class="modal hidden">
        <div class="modal-content">
            <div class="modal-header">
                <h2>‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ (‡πÉ‡∏ä‡πâ‡∏£‡πà‡∏ß‡∏°‡∏Å‡∏±‡∏ô‡∏ó‡∏∏‡∏Å‡∏ï‡∏≤‡∏£‡∏≤‡∏á)</h2>
                <button id="closeModalBtn" class="btn-icon"><i class="fa-solid fa-xmark"></i></button>
            </div>
            <div class="modal-body">
                <div class="status-list" id="statusList">
                    <!-- Status items will be rendered here -->
                </div>
                <div class="add-status-form">
                    <input type="text" id="newStatusLabel" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÉ‡∏´‡∏°‡πà" class="input-sm">
                    <input type="color" id="newStatusColor" value="#4f46e5" class="color-input">
                    <button id="addStatusBtn" class="btn-sm btn-primary">‡πÄ‡∏û‡∏¥‡πà‡∏°</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Add Table Modal -->
    <div id="addTableModal" class="modal hidden">
        <div class="modal-content">
            <div class="modal-header">
                <h2>‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡πÉ‡∏´‡∏°‡πà</h2>
                <button id="closeTableModalBtn" class="btn-icon"><i class="fa-solid fa-xmark"></i></button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label for="newTableName">‡∏ä‡∏∑‡πà‡∏≠‡∏ï‡∏≤‡∏£‡∏≤‡∏á</label>
                    <input type="text" id="newTableName" class="input-full" placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡∏á‡∏≤‡∏ô‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏°‡∏Å‡∏£‡∏≤‡∏Ñ‡∏°, ‡πÇ‡∏õ‡∏£‡πÄ‡∏à‡∏Ñ A">
                </div>
                <div class="form-actions">
                    <button id="confirmAddTableBtn" class="btn-primary full-width">‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏ï‡∏≤‡∏£‡∏≤‡∏á</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Show Hidden Tables Modal -->
    <div id="hiddenTablesModal" class="modal hidden">
        <div class="modal-content">
            <div class="modal-header">
                <h2>‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏ó‡∏µ‡πà‡∏ã‡πà‡∏≠‡∏ô‡πÑ‡∏ß‡πâ</h2>
                <button id="closeHiddenModalBtn" class="btn-icon"><i class="fa-solid fa-xmark"></i></button>
            </div>
            <div class="modal-body">
                <div id="hiddenTablesList" class="hidden-tables-list">
                    <!-- Hidden tables will be rendered here -->
                </div>
            </div>
        </div>
    </div>

    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
<script>
document.addEventListener('DOMContentLoaded', () => {
    const boardWrapper = document.getElementById('boardWrapper');
    const emptyBoardState = document.getElementById('emptyBoardState');
    const addTableBtn = document.getElementById('addTableBtn');
    const settingsBtn = document.getElementById('settingsBtn');
    const undoBtn = document.getElementById('undoBtn');
    const saveJsonBtn = document.getElementById('saveJsonBtn');
    const exportExcelBtn = document.getElementById('exportExcelBtn');
    const toggleTimestampBtn = document.getElementById('toggleTimestampBtn');
    const timestampStatus = document.getElementById('timestampStatus');
    const fontIncreaseBtn = document.getElementById('fontIncreaseBtn');
    const fontDecreaseBtn = document.getElementById('fontDecreaseBtn');
    const themeToggleBtn = document.getElementById('themeToggleBtn');
    const settingsModal = document.getElementById('settingsModal');
    const closeModalBtn = document.getElementById('closeModalBtn');
    const statusList = document.getElementById('statusList');
    const addStatusBtn = document.getElementById('addStatusBtn');
    const newStatusLabel = document.getElementById('newStatusLabel');
    const newStatusColor = document.getElementById('newStatusColor');
    const addTableModal = document.getElementById('addTableModal');
    const closeTableModalBtn = document.getElementById('closeTableModalBtn');
    const confirmAddTableBtn = document.getElementById('confirmAddTableBtn');
    const newTableNameInput = document.getElementById('newTableName');
    const hiddenTablesModal = document.getElementById('hiddenTablesModal');
    const closeHiddenModalBtn = document.getElementById('closeHiddenModalBtn');
    const showHiddenBtn = document.getElementById('showHiddenBtn');
    const hiddenTablesList = document.getElementById('hiddenTablesList');

    let autoTimestampEnabled = localStorage.getItem('autoTimestampEnabled') === 'true' || false;
    let fontSize = parseInt(localStorage.getItem('fontSize')) || 100;
    let isDarkMode = localStorage.getItem('isDarkMode') !== 'false';

    // ===== Firebase config (REPLACE WITH YOUR OWN PROJECT SETTINGS) =====
    const firebaseConfig = {
  apiKey: "AIzaSyCDMmFHwnAhf8XkbDpUfjyVGC1D3MDOUr4",
  authDomain: "table-d7433.firebaseapp.com",
  projectId: "table-d7433",
  storageBucket: "table-d7433.firebasestorage.app",
  messagingSenderId: "662009330082",
  appId: "1:662009330082:web:5138e045f52925f0e39afb",
  measurementId: "G-YB276YRVWK"
};

    let firebaseApp = null;
    let db = null;
    let workspaceId = localStorage.getItem('workspaceId') || "";
    let isApplyingRemote = false;

    function askForWorkspaceId() {
        let id = workspaceId || prompt('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÉ‡∏™‡πà‡∏£‡∏´‡∏±‡∏™‡∏´‡πâ‡∏≠‡∏á/‡∏ä‡∏∑‡πà‡∏≠‡πÇ‡∏õ‡∏£‡πÄ‡∏à‡∏Å‡∏ï‡πå‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏ä‡πâ‡∏ã‡∏¥‡∏á‡∏Ñ‡πå‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏£‡πà‡∏ß‡∏°‡∏Å‡∏±‡∏ô', 'default-room');
        if (!id) id = 'default-room';
        id = id.trim();
        workspaceId = id;
        localStorage.setItem('workspaceId', workspaceId);
    }

    function initFirebase() {
        if (!window.firebase) {
            console.warn('Firebase SDK ‡πÑ‡∏°‡πà‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô (‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏≠‡∏¥‡∏ô‡πÄ‡∏ó‡∏≠‡∏£‡πå‡πÄ‡∏ô‡πá‡∏ï)');
            return;
        }
        if (firebaseConfig.apiKey === "YOUR_API_KEY") {
            console.warn('‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ Firebase config ‡πÉ‡∏ô‡πÑ‡∏ü‡∏•‡πå app');
            return;
        }
        try {
            firebaseApp = firebase.apps && firebase.apps.length ? firebase.app() : firebase.initializeApp(firebaseConfig);
            db = firebase.firestore();
        } catch (e) {
            console.error('Firebase init error', e);
        }
    }

    function saveToFirebase() {
        if (!db || !workspaceId || isApplyingRemote) return;
        try {
            db.collection('workspaces').doc(workspaceId).set({
                boards,
                statusOptions,
                autoTimestampEnabled,
                fontSize,
                isDarkMode,
                updatedAt: firebase.firestore.FieldValue.serverTimestamp()
            }, { merge: true });
        } catch (e) {
            console.error('Save to Firebase error', e);
        }
    }

    function initFirebaseSync() {
        if (!db) return;
        askForWorkspaceId();
        if (!workspaceId) return;

        const docRef = db.collection('workspaces').doc(workspaceId);

        docRef.get().then(doc => {
            if (doc.exists) {
                const data = doc.data() || {};
                isApplyingRemote = true;
                boards = data.boards || boards;
                statusOptions = data.statusOptions || statusOptions;
                autoTimestampEnabled = typeof data.autoTimestampEnabled === 'boolean' ? data.autoTimestampEnabled : autoTimestampEnabled;
                fontSize = data.fontSize || fontSize;
                isDarkMode = typeof data.isDarkMode === 'boolean' ? data.isDarkMode : isDarkMode;

                localStorage.setItem('boards', JSON.stringify(boards));
                localStorage.setItem('statusOptions', JSON.stringify(statusOptions));
                localStorage.setItem('autoTimestampEnabled', autoTimestampEnabled);
                localStorage.setItem('fontSize', fontSize);
                localStorage.setItem('isDarkMode', isDarkMode);

                updateTimestampButton();
                updateFontSize();
                updateTheme();
                renderBoard();
                isApplyingRemote = false;
            } else {
                // ‡∏ñ‡πâ‡∏≤‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ô cloud ‡πÉ‡∏´‡πâ‡πÉ‡∏ä‡πâ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ô‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡πÄ‡∏õ‡πá‡∏ô‡∏Ñ‡πà‡∏≤‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô
                saveToFirebase();
            }
        }).catch(console.error);

        docRef.onSnapshot(snapshot => {
            if (!snapshot.exists) return;
            const data = snapshot.data();
            if (!data) return;
            isApplyingRemote = true;
            boards = data.boards || [];
            statusOptions = data.statusOptions || statusOptions;
            autoTimestampEnabled = typeof data.autoTimestampEnabled === 'boolean' ? data.autoTimestampEnabled : autoTimestampEnabled;
            fontSize = data.fontSize || fontSize;
            isDarkMode = typeof data.isDarkMode === 'boolean' ? data.isDarkMode : isDarkMode;

            localStorage.setItem('boards', JSON.stringify(boards));
            localStorage.setItem('statusOptions', JSON.stringify(statusOptions));
            localStorage.setItem('autoTimestampEnabled', autoTimestampEnabled);
            localStorage.setItem('fontSize', fontSize);
            localStorage.setItem('isDarkMode', isDarkMode);

            updateTimestampButton();
            updateFontSize();
            updateTheme();
            renderBoard();
            isApplyingRemote = false;
        });
    }

    const style = document.createElement('style');
    style.textContent = `
        @keyframes rainbow {
            0% { color: #ff0000; }
            16% { color: #ff7f00; }
            33% { color: #ffff00; }
            50% { color: #00ff00; }
            66% { color: #0000ff; }
            83% { color: #8b00ff; }
            100% { color: #ff0000; }
        }
        @keyframes rainbowGlow {
            0% { text-shadow: 0 0 10px #ff0000, 0 0 20px #ff0000, 0 0 30px #ff0000; }
            16% { text-shadow: 0 0 10px #ff7f00, 0 0 20px #ff7f00, 0 0 30px #ff7f00; }
            33% { text-shadow: 0 0 10px #ffff00, 0 0 20px #ffff00, 0 0 30px #ffff00; }
            50% { text-shadow: 0 0 10px #00ff00, 0 0 20px #00ff00, 0 0 30px #00ff00; }
            66% { text-shadow: 0 0 10px #0000ff, 0 0 20px #0000ff, 0 0 30px #0000ff; }
            83% { text-shadow: 0 0 10px #8b00ff, 0 0 20px #8b00ff, 0 0 30px #8b00ff; }
            100% { text-shadow: 0 0 10px #ff0000, 0 0 20px #ff0000, 0 0 30px #ff0000; }
        }
        @keyframes rainbowScroll {
            0% { 
                background: linear-gradient(90deg, #ff0000 0%, #ff7f00 16%, #ffff00 33%, #00ff00 50%, #0000ff 66%, #8b00ff 83%, #ff0000 100%);
                background-size: 200% 100%;
                background-position: 0% 0%;
                -webkit-background-clip: text;
                background-clip: text;
                -webkit-text-fill-color: transparent;
            }
            100% { 
                background: linear-gradient(90deg, #ff0000 0%, #ff7f00 16%, #ffff00 33%, #00ff00 50%, #0000ff 66%, #8b00ff 83%, #ff0000 100%);
                background-size: 200% 100%;
                background-position: 200% 0%;
                -webkit-background-clip: text;
                background-clip: text;
                -webkit-text-fill-color: transparent;
            }
        }
        .rainbow-text {
            animation: rainbow 3s linear infinite, rainbowGlow 3s linear infinite;
            font-weight: 600;
        }
        .rainbow-stroke {
            animation: rainbowScroll 3s linear infinite;
            background: linear-gradient(90deg, #ff0000 0%, #ff7f00 16%, #ffff00 33%, #00ff00 50%, #0000ff 66%, #8b00ff 83%, #ff0000 100%);
            background-size: 200% 100%;
            -webkit-background-clip: text;
            background-clip: text;
            -webkit-text-fill-color: transparent;
            font-weight: 700;
        }
    `;
    document.head.appendChild(style);

    function updateTimestampButton() {
        if (autoTimestampEnabled) {
            timestampStatus.textContent = '‡πÄ‡∏õ‡∏¥‡∏î';
            toggleTimestampBtn.style.backgroundColor = 'var(--primary-color)';
            toggleTimestampBtn.style.color = 'white';
            toggleTimestampBtn.style.borderColor = 'var(--primary-color)';
        } else {
            timestampStatus.textContent = '‡∏õ‡∏¥‡∏î';
            toggleTimestampBtn.style.backgroundColor = 'var(--bg-color)';
            toggleTimestampBtn.style.color = 'var(--text-secondary)';
            toggleTimestampBtn.style.borderColor = 'var(--border-color)';
        }
    }

    function updateFontSize() {
        const root = document.documentElement;
        const scale = fontSize / 100;
        root.style.setProperty('--font-size-base', `${0.9 * scale}rem`);
        root.style.setProperty('--font-size-sm', `${0.8 * scale}rem`);
        root.style.setProperty('--font-size-lg', `${1.05 * scale}rem`);
        root.style.setProperty('--font-size-header', `${1.3 * scale}rem`);
        localStorage.setItem('fontSize', fontSize);
    }

    function increaseFontSize() {
        if (fontSize < 150) {
            fontSize += 10;
            updateFontSize();
        }
    }

    function decreaseFontSize() {
        if (fontSize > 70) {
            fontSize -= 10;
            updateFontSize();
        }
    }

    function updateTheme() {
        if (isDarkMode) {
            document.body.classList.remove('light-mode');
        } else {
            document.body.classList.add('light-mode');
        }
        localStorage.setItem('isDarkMode', isDarkMode);
    }

    function toggleTheme() {
        isDarkMode = !isDarkMode;
        updateTheme();
    }

    function getCurrentTime() {
        const now = new Date();
        return now.toLocaleTimeString('th-TH', {
            hour: '2-digit',
            minute: '2-digit',
            second: '2-digit'
        });
    }

    function saveAsJson() {
        const data = {
            boards: boards,
            statusOptions: statusOptions,
            exportDate: new Date().toISOString()
        };
        const dataStr = JSON.stringify(data, null, 2);
        const dataBlob = new Blob([dataStr], { type: 'application/json' });
        const url = URL.createObjectURL(dataBlob);
        const link = document.createElement('a');
        link.href = url;
        link.download = `table-data-${new Date().toISOString().slice(0, 10)}.json`;
        link.click();
        URL.revokeObjectURL(url);
    }

    function exportToExcel() {
        let csvContent = '';
        boards.forEach((board, boardIndex) => {
            if (board.hidden) return;
            csvContent += `\n"${board.title}"\n`;
            csvContent += '"No.","‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£","‡πÄ‡∏ß‡∏•‡∏≤","‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞","‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà"\n';
            const sortedRows = [...board.rows].sort((a, b) => new Date(a.date) - new Date(b.date));
            sortedRows.forEach((row, index) => {
                const statusLabel = statusOptions.find(s => s.value === row.status)?.label || row.status;
                const title = (row.title || '').replace(/"/g, '""');
                const time = row.time || '';
                const date = row.date || '';
                csvContent += `${index + 1},"${title}","${time}","${statusLabel}","${date}"\n`;
            });
            if (boardIndex < boards.length - 1) {
                csvContent += '\n';
            }
        });
        const BOM = '\uFEFF';
        const blob = new Blob([BOM + csvContent], { type: 'text/csv;charset=utf-8;' });
        const url = URL.createObjectURL(blob);
        const link = document.createElement('a');
        link.href = url;
        link.download = `table-export-${new Date().toISOString().slice(0, 10)}.csv`;
        link.click();
        URL.revokeObjectURL(url);
    }

    let boards = JSON.parse(localStorage.getItem('boards')) || [];
    const oldData = JSON.parse(localStorage.getItem('tableData'));
    if (oldData && boards.length === 0) {
        boards.push({
            id: Date.now(),
            title: "‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏´‡∏•‡∏±‡∏Å (Migrated)",
            rows: oldData,
            hidden: false
        });
        localStorage.removeItem('tableData');
        localStorage.setItem('boards', JSON.stringify(boards));
    }

    let statusOptions = JSON.parse(localStorage.getItem('statusOptions')) || [
        { id: 's1', value: 'todo', label: '‡∏£‡∏≠‡πÄ‡∏£‡∏¥‡πà‡∏°', color: '#6b7280' },
        { id: 's2', value: 'in-progress', label: '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ó‡∏≥', color: '#3b82f6' },
        { id: 's3', value: 'done', label: '‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô', color: '#10b981' },
        { id: 's4', value: 'hold', label: '‡∏ï‡∏¥‡∏î‡∏Ç‡∏±‡∏î', color: '#f59e0b' }
    ];

    let historyStack = [];
    const MAX_HISTORY = 50;
    const columns = [
        { id: 'title', label: '‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£', width: '60%' },
        { id: 'time', label: '‡πÄ‡∏ß‡∏•‡∏≤', width: '20%' }
    ];

    let activeCell = null;
    let colorPickerMenu = null;
    let currentColorMode = 'text';
    let currentScope = 'cell';
    let glowEnabled = false;
    let rainbowEnabled = false;
    let rainbowStrokeEnabled = false;

    function createColorPickerMenu() {
        if (colorPickerMenu) return colorPickerMenu;
        const menu = document.createElement('div');
        menu.style.cssText = `position: fixed; background: var(--card-bg); border: 1px solid var(--border-color); border-radius: 8px; padding: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.3); z-index: 10000; display: none; min-width: 240px; max-height: 80vh; overflow-y: auto;`;
        const tabs = document.createElement('div');
        tabs.className = 'color-picker-tabs';
        tabs.innerHTML = `<button class="color-tab active" data-mode="text">‡∏™‡∏µ‡∏ï‡∏±‡∏ß‡∏≠‡∏±‡∏Å‡∏©‡∏£</button><button class="color-tab" data-mode="background">‡∏™‡∏µ‡∏û‡∏∑‡πâ‡∏ô‡∏´‡∏•‡∏±‡∏á</button>`;
        menu.appendChild(tabs);
        const scopeSection = document.createElement('div');
        scopeSection.style.cssText = 'margin: 12px 0; padding: 8px; background: var(--bg-color); border-radius: 6px;';
        scopeSection.innerHTML = `<div style="font-size: 0.85rem; margin-bottom: 6px; color: var(--text-secondary);">‡πÉ‡∏ä‡πâ‡∏™‡∏µ‡∏Å‡∏±‡∏ö:</div><div style="display: flex; gap: 8px;"><button class="scope-btn active" data-scope="cell" style="flex: 1; padding: 6px; border: 1px solid var(--primary-color); background: var(--primary-color)20; color: var(--primary-color); border-radius: 4px; cursor: pointer; font-size: 0.85rem; font-weight: 500;">‡πÄ‡∏ã‡∏•‡∏•‡πå‡∏ô‡∏µ‡πâ</button><button class="scope-btn" data-scope="column" style="flex: 1; padding: 6px; border: 1px solid var(--border-color); background: transparent; color: var(--text-secondary); border-radius: 4px; cursor: pointer; font-size: 0.85rem;">‡∏ó‡∏±‡πâ‡∏á‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå</button></div>`;
        menu.appendChild(scopeSection);
        const effectSection = document.createElement('div');
        effectSection.style.cssText = 'margin: 12px 0; padding: 8px; background: var(--bg-color); border-radius: 6px;';
        effectSection.innerHTML = `<label style="display: flex; align-items: center; gap: 8px; cursor: pointer; font-size: 0.85rem; color: var(--text-secondary); margin-bottom: 6px;"><input type="checkbox" id="glowToggle" style="width: 16px; height: 16px; cursor: pointer;"><span>‡πÄ‡∏£‡∏∑‡∏≠‡∏á‡πÅ‡∏™‡∏á ‚ú®</span></label><label style="display: flex; align-items: center; gap: 8px; cursor: pointer; font-size: 0.85rem; color: var(--text-secondary); margin-bottom: 6px;"><input type="checkbox" id="rainbowToggle" style="width: 16px; height: 16px; cursor: pointer;"><span>‡πÑ‡∏ü‡∏ß‡∏¥‡πà‡∏á (‡πÄ‡∏ï‡πá‡∏°‡∏ï‡∏±‡∏ß) üåà</span></label><label style="display: flex; align-items: center; gap: 8px; cursor: pointer; font-size: 0.85rem; color: var(--text-secondary);"><input type="checkbox" id="rainbowStrokeToggle" style="width: 16px; height: 16px; cursor: pointer;"><span>‡πÑ‡∏ü‡∏ß‡∏¥‡πà‡∏á (‡∏Ç‡∏≠‡∏ö‡∏ï‡∏±‡∏ß) üé®</span></label>`;
        menu.appendChild(effectSection);
        const title = document.createElement('div');
        title.textContent = '‡∏™‡∏µ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à‡∏£‡∏π‡∏õ:';
        title.style.cssText = 'font-size: 0.85rem; margin-bottom: 8px; margin-top: 8px; color: var(--text-secondary); font-weight: 500;';
        menu.appendChild(title);
        const colorGrid = document.createElement('div');
        colorGrid.style.cssText = 'display: grid; grid-template-columns: repeat(4, 1fr); gap: 6px; margin-bottom: 12px;';
        const solidColors = [
            { name: '‡∏Ç‡∏≤‡∏ß', value: '#ffffff' }, { name: '‡πÄ‡∏ó‡∏≤‡∏≠‡πà‡∏≠‡∏ô', value: '#d1d5db' }, { name: '‡πÄ‡∏ó‡∏≤', value: '#9ca3af' }, { name: '‡πÄ‡∏ó‡∏≤‡πÄ‡∏Ç‡πâ‡∏°', value: '#4b5563' },
            { name: '‡πÅ‡∏î‡∏á', value: '#ef4444' }, { name: '‡∏™‡πâ‡∏°', value: '#f97316' }, { name: '‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏á', value: '#eab308' }, { name: '‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ß', value: '#22c55e' },
            { name: '‡∏ü‡πâ‡∏≤', value: '#3b82f6' }, { name: '‡∏ô‡πâ‡∏≥‡πÄ‡∏á‡∏¥‡∏ô', value: '#2563eb' }, { name: '‡∏°‡πà‡∏ß‡∏á', value: '#a855f7' }, { name: '‡∏ä‡∏°‡∏û‡∏π', value: '#ec4899' }
        ];
        solidColors.forEach(color => {
            const btn = document.createElement('button');
            btn.style.cssText = `width: 50px; height: 32px; border: 2px solid var(--border-color); border-radius: 4px; cursor: pointer; background: ${color.value}; transition: transform 0.2s;`;
            btn.title = color.name;
            btn.dataset.colorValue = color.value;
            colorGrid.appendChild(btn);
        });
        menu.appendChild(colorGrid);
        const transTitle = document.createElement('div');
        transTitle.textContent = '‡∏™‡∏µ‡πÇ‡∏õ‡∏£‡πà‡∏á‡πÅ‡∏™‡∏á:';
        transTitle.style.cssText = 'font-size: 0.85rem; margin-bottom: 8px; color: var(--text-secondary); font-weight: 500;';
        menu.appendChild(transTitle);
        const transGrid = document.createElement('div');
        transGrid.style.cssText = 'display: grid; grid-template-columns: repeat(4, 1fr); gap: 6px; margin-bottom: 12px;';
        const transparentColors = [
            { name: '‡πÅ‡∏î‡∏á‡∏≠‡πà‡∏≠‡∏ô', value: 'rgba(239, 68, 68, 0.2)' }, { name: '‡∏™‡πâ‡∏°‡∏≠‡πà‡∏≠‡∏ô', value: 'rgba(249, 115, 22, 0.2)' },
            { name: '‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏á‡∏≠‡πà‡∏≠‡∏ô', value: 'rgba(234, 179, 8, 0.2)' }, { name: '‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ß‡∏≠‡πà‡∏≠‡∏ô', value: 'rgba(34, 197, 94, 0.2)' },
            { name: '‡∏ü‡πâ‡∏≤‡∏≠‡πà‡∏≠‡∏ô', value: 'rgba(59, 130, 246, 0.2)' }, { name: '‡∏ô‡πâ‡∏≥‡πÄ‡∏á‡∏¥‡∏ô‡∏≠‡πà‡∏≠‡∏ô', value: 'rgba(37, 99, 235, 0.2)' },
            { name: '‡∏°‡πà‡∏ß‡∏á‡∏≠‡πà‡∏≠‡∏ô', value: 'rgba(168, 85, 247, 0.2)' }, { name: '‡∏ä‡∏°‡∏û‡∏π‡∏≠‡πà‡∏≠‡∏ô', value: 'rgba(236, 72, 153, 0.2)' }
        ];
        transparentColors.forEach(color => {
            const btn = document.createElement('button');
            btn.style.cssText = `width: 50px; height: 32px; border: 2px solid var(--border-color); border-radius: 4px; cursor: pointer; background: ${color.value}; transition: transform 0.2s;`;
            btn.title = color.name;
            btn.dataset.colorValue = color.value;
            transGrid.appendChild(btn);
        });
        menu.appendChild(transGrid);
        const customSection = document.createElement('div');
        customSection.style.cssText = 'margin-top: 12px; padding-top: 12px; border-top: 1px solid var(--border-color);';
        const customLabel = document.createElement('div');
        customLabel.textContent = '‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏™‡∏µ‡πÄ‡∏≠‡∏á:';
        customLabel.style.cssText = 'font-size: 0.85rem; margin-bottom: 8px; color: var(--text-secondary); font-weight: 500;';
        customSection.appendChild(customLabel);
        const customInput = document.createElement('input');
        customInput.type = 'color';
        customInput.id = 'customColorInput';
        customInput.style.cssText = 'width: 100%; height: 40px; border: 1px solid var(--border-color); border-radius: 6px; cursor: pointer;';
        customSection.appendChild(customInput);
        menu.appendChild(customSection);
        const clearBtn = document.createElement('button');
        clearBtn.textContent = 'üîÑ ‡∏•‡πâ‡∏≤‡∏á‡∏™‡∏µ‡πÅ‡∏•‡∏∞‡πÄ‡∏≠‡∏ü‡πÄ‡∏ü‡∏Å‡∏ï‡πå';
        clearBtn.className = 'btn-secondary btn-sm';
        clearBtn.style.cssText = 'width: 100%; margin-top: 8px;';
        clearBtn.dataset.colorValue = '';
        clearBtn.dataset.clearAll = 'true';
        menu.appendChild(clearBtn);
        document.body.appendChild(menu);
        colorPickerMenu = menu;
        return menu;
    }

    function showColorPicker(cell, event, isDateHeader = false, isTableHeader = false) {
        if (!event.ctrlKey) return;
        event.preventDefault();
        event.stopPropagation();

        // Check if there's a text selection
        const selection = window.getSelection();
        const hasSelection = selection && selection.toString().trim().length > 0;

        activeCell = cell;
        const menu = createColorPickerMenu();
        const tabs = menu.querySelectorAll('.color-tab');
        tabs.forEach(tab => {
            tab.onclick = () => {
                tabs.forEach(t => t.classList.remove('active'));
                tab.classList.add('active');
                currentColorMode = tab.dataset.mode;
            };
        });

        const scopeBtns = menu.querySelectorAll('.scope-btn');
        if (hasSelection) {
            // Hide scope buttons when text is selected
            scopeBtns.forEach(btn => btn.style.display = 'none');
        } else {
            scopeBtns.forEach(btn => {
                btn.style.display = '';
                btn.onclick = () => {
                    scopeBtns.forEach(b => {
                        b.classList.remove('active');
                        b.style.border = '1px solid var(--border-color)';
                        b.style.background = 'transparent';
                        b.style.color = 'var(--text-secondary)';
                    });
                    btn.classList.add('active');
                    btn.style.border = '1px solid var(--primary-color)';
                    btn.style.background = 'var(--primary-color)20';
                    btn.style.color = 'var(--primary-color)';
                    currentScope = btn.dataset.scope;
                };
            });
        }

        const glowToggle = menu.querySelector('#glowToggle');
        if (glowToggle) {
            glowToggle.checked = glowEnabled;
            glowToggle.onchange = () => { glowEnabled = glowToggle.checked; };
        }
        const rainbowToggle = menu.querySelector('#rainbowToggle');
        if (rainbowToggle) {
            rainbowToggle.checked = rainbowEnabled;
            rainbowToggle.onchange = () => {
                rainbowEnabled = rainbowToggle.checked;
                if (rainbowEnabled && rainbowStrokeEnabled) {
                    rainbowStrokeEnabled = false;
                    const strokeToggle = menu.querySelector('#rainbowStrokeToggle');
                    if (strokeToggle) strokeToggle.checked = false;
                }
            };
        }
        const rainbowStrokeToggle = menu.querySelector('#rainbowStrokeToggle');
        if (rainbowStrokeToggle) {
            rainbowStrokeToggle.checked = rainbowStrokeEnabled;
            rainbowStrokeToggle.onchange = () => {
                rainbowStrokeEnabled = rainbowStrokeToggle.checked;
                if (rainbowStrokeEnabled && rainbowEnabled) {
                    rainbowEnabled = false;
                    const fullToggle = menu.querySelector('#rainbowToggle');
                    if (fullToggle) fullToggle.checked = false;
                }
            };
        }

        function applyColor(colorValue) {
            if (!activeCell) return;

            // Apply to selected text only
            if (hasSelection) {
                const range = selection.getRangeAt(0);
                const span = document.createElement('span');

                if (currentColorMode === 'text') {
                    if (rainbowEnabled) {
                        span.className = 'rainbow-text';
                    } else if (rainbowStrokeEnabled) {
                        span.className = 'rainbow-stroke';
                    } else {
                        span.style.color = colorValue || '';
                        if (glowEnabled && colorValue) {
                            span.style.textShadow = `0 0 10px ${colorValue}, 0 0 20px ${colorValue}`;
                        }
                    }
                } else {
                    span.style.backgroundColor = colorValue || '';
                    if (glowEnabled && colorValue) {
                        span.style.boxShadow = `inset 0 0 20px ${colorValue}40, 0 0 10px ${colorValue}30`;
                    }
                }

                try {
                    range.surroundContents(span);
                } catch (e) {
                    // If surroundContents fails, use extractContents and appendChild
                    const contents = range.extractContents();
                    span.appendChild(contents);
                    range.insertNode(span);
                }

                selection.removeAllRanges();
                menu.style.display = 'none';
                return;
            }

            // Original cell/column coloring logic
            if (isDateHeader) {
                const date = activeCell.dataset.date;
                const boardId = parseInt(activeCell.closest('.table-card').dataset.boardId);
                const board = boards.find(b => b.id === boardId);
                if (board) {
                    if (!board.dateColors) board.dateColors = {};
                    if (!board.dateColors[date]) board.dateColors[date] = {};
                    activeCell.classList.remove('rainbow-text', 'rainbow-stroke');
                    if (currentColorMode === 'text') {
                        if (rainbowEnabled) {
                            activeCell.classList.add('rainbow-text');
                            activeCell.style.color = '';
                            activeCell.style.textShadow = '';
                            board.dateColors[date].rainbow = true;
                            board.dateColors[date].rainbowStroke = false;
                            board.dateColors[date].color = '';
                        } else if (rainbowStrokeEnabled) {
                            activeCell.classList.add('rainbow-stroke');
                            activeCell.style.color = '';
                            activeCell.style.textShadow = '';
                            board.dateColors[date].rainbowStroke = true;
                            board.dateColors[date].rainbow = false;
                            board.dateColors[date].color = '';
                        } else {
                            activeCell.style.color = colorValue || '';
                            board.dateColors[date].color = colorValue;
                            board.dateColors[date].rainbow = false;
                            board.dateColors[date].rainbowStroke = false;
                            if (glowEnabled && colorValue) {
                                activeCell.style.textShadow = `0 0 10px ${colorValue}, 0 0 20px ${colorValue}`;
                            } else {
                                activeCell.style.textShadow = '';
                            }
                        }
                    } else {
                        activeCell.style.backgroundColor = colorValue || '';
                        board.dateColors[date].bgColor = colorValue;
                        if (glowEnabled && colorValue) {
                            activeCell.style.boxShadow = `inset 0 0 20px ${colorValue}40, 0 0 10px ${colorValue}30`;
                        } else {
                            activeCell.style.boxShadow = '';
                        }
                    }
                    board.dateColors[date].glow = glowEnabled;
                    // Clear date colors data when resetting
                    if (!colorValue && !glowEnabled && !rainbowEnabled && !rainbowStrokeEnabled) {
                        delete board.dateColors[date];
                    }
                    saveToLocalStorage();
                }
            } else if (isTableHeader) {
                const boardId = parseInt(activeCell.closest('.table-card').dataset.boardId);
                const board = boards.find(b => b.id === boardId);
                const headerType = activeCell.dataset.headerType;
                if (board) {
                    if (!board.headerColors) board.headerColors = {};
                    if (!board.headerColors[headerType]) board.headerColors[headerType] = {};
                    activeCell.classList.remove('rainbow-text', 'rainbow-stroke');
                    if (currentColorMode === 'text') {
                        if (rainbowEnabled) {
                            activeCell.classList.add('rainbow-text');
                            activeCell.style.color = '';
                            activeCell.style.textShadow = '';
                            board.headerColors[headerType].rainbow = true;
                            board.headerColors[headerType].rainbowStroke = false;
                            board.headerColors[headerType].color = '';
                        } else if (rainbowStrokeEnabled) {
                            activeCell.classList.add('rainbow-stroke');
                            activeCell.style.color = '';
                            activeCell.style.textShadow = '';
                            board.headerColors[headerType].rainbowStroke = true;
                            board.headerColors[headerType].rainbow = false;
                            board.headerColors[headerType].color = '';
                        } else {
                            activeCell.style.color = colorValue || '';
                            board.headerColors[headerType].color = colorValue;
                            board.headerColors[headerType].rainbow = false;
                            board.headerColors[headerType].rainbowStroke = false;
                            if (glowEnabled && colorValue) {
                                activeCell.style.textShadow = `0 0 10px ${colorValue}, 0 0 20px ${colorValue}`;
                            } else {
                                activeCell.style.textShadow = '';
                            }
                        }
                    } else {
                        activeCell.style.backgroundColor = colorValue || '';
                        board.headerColors[headerType].bgColor = colorValue;
                        if (glowEnabled && colorValue) {
                            activeCell.style.boxShadow = `inset 0 0 20px ${colorValue}40, 0 0 10px ${colorValue}30`;
                        } else {
                            activeCell.style.boxShadow = '';
                        }
                    }
                    board.headerColors[headerType].glow = glowEnabled;
                    // Clear header colors data when resetting
                    if (!colorValue && !glowEnabled && !rainbowEnabled && !rainbowStrokeEnabled) {
                        delete board.headerColors[headerType];
                    }
                    saveToLocalStorage();
                }
            } else {
                const tr = activeCell.closest('tr');
                const boardId = parseInt(activeCell.closest('.table-card').dataset.boardId);
                const itemId = parseInt(tr.dataset.id);
                const fieldName = activeCell.dataset.field;
                const tableCard = activeCell.closest('.table-card');
                let cellsToColor = [];
                let itemsToUpdate = [];
                if (currentScope === 'column') {
                    const allCellsInColumn = tableCard.querySelectorAll(`td[data-field="${fieldName}"]`);
                    cellsToColor = Array.from(allCellsInColumn);
                    const board = boards.find(b => b.id === boardId);
                    if (board) itemsToUpdate = board.rows;
                } else {
                    cellsToColor = [activeCell];
                    const board = boards.find(b => b.id === boardId);
                    if (board) {
                        const item = board.rows.find(r => r.id === itemId);
                        if (item) itemsToUpdate = [item];
                    }
                }
                cellsToColor.forEach(td => {
                    const target = td.querySelector('.editable') || td;
                    if (currentColorMode === 'text') {
                        target.classList.remove('rainbow-text', 'rainbow-stroke');
                        if (rainbowEnabled) {
                            target.classList.add('rainbow-text');
                            target.style.color = '';
                            target.style.textShadow = '';
                        } else if (rainbowStrokeEnabled) {
                            target.classList.add('rainbow-stroke');
                            target.style.color = '';
                            target.style.textShadow = '';
                        } else {
                            target.style.color = colorValue || '';
                            if (glowEnabled && colorValue) {
                                target.style.textShadow = `0 0 10px ${colorValue}, 0 0 20px ${colorValue}`;
                            } else {
                                target.style.textShadow = '';
                            }
                        }
                    } else {
                        target.style.backgroundColor = colorValue || '';
                        if (glowEnabled && colorValue) {
                            target.style.boxShadow = `inset 0 0 20px ${colorValue}40, 0 0 10px ${colorValue}30`;
                        } else {
                            target.style.boxShadow = '';
                        }
                    }
                });
                itemsToUpdate.forEach(item => {
                    if (!item.cellColors) item.cellColors = {};
                    if (!item.cellBgColors) item.cellBgColors = {};
                    if (!item.cellGlow) item.cellGlow = {};
                    if (!item.cellRainbow) item.cellRainbow = {};
                    if (!item.cellRainbowStroke) item.cellRainbowStroke = {};
                    if (currentColorMode === 'text') {
                        item.cellColors[fieldName] = colorValue;
                        item.cellRainbow[fieldName] = rainbowEnabled;
                        item.cellRainbowStroke[fieldName] = rainbowStrokeEnabled;
                        // Clear data when resetting
                        if (!colorValue && !rainbowEnabled && !rainbowStrokeEnabled) {
                            delete item.cellColors[fieldName];
                            delete item.cellRainbow[fieldName];
                            delete item.cellRainbowStroke[fieldName];
                        }
                    } else {
                        item.cellBgColors[fieldName] = colorValue;
                        // Clear data when resetting
                        if (!colorValue) {
                            delete item.cellBgColors[fieldName];
                        }
                    }
                    item.cellGlow[fieldName] = glowEnabled;
                    // Clear glow data when resetting
                    if (!glowEnabled) {
                        delete item.cellGlow[fieldName];
                    }
                });
                saveToLocalStorage();
            }
            menu.style.display = 'none';
        }
        const buttons = menu.querySelectorAll('button[data-color-value]');
        buttons.forEach(btn => {
            const newBtn = btn.cloneNode(true);
            btn.parentNode.replaceChild(newBtn, btn);
            newBtn.onclick = () => {
                if (newBtn.dataset.clearAll === 'true') {
                    glowEnabled = false;
                    rainbowEnabled = false;
                    rainbowStrokeEnabled = false;
                    const glowToggle = menu.querySelector('#glowToggle');
                    const rainbowToggle = menu.querySelector('#rainbowToggle');
                    const rainbowStrokeToggle = menu.querySelector('#rainbowStrokeToggle');
                    if (glowToggle) glowToggle.checked = false;
                    if (rainbowToggle) rainbowToggle.checked = false;
                    if (rainbowStrokeToggle) rainbowStrokeToggle.checked = false;
                }
                applyColor(newBtn.dataset.colorValue);
                // Refresh table to apply changes immediately
                if (newBtn.dataset.clearAll === 'true') {
                    setTimeout(() => renderBoard(), 50);
                }
            };
            newBtn.onmouseenter = () => newBtn.style.transform = 'scale(1.1)';
            newBtn.onmouseleave = () => newBtn.style.transform = 'scale(1)';
        });
        const customInput = menu.querySelector('#customColorInput');
        if (customInput) {
            const newInput = customInput.cloneNode(true);
            customInput.parentNode.replaceChild(newInput, customInput);
            newInput.onchange = () => applyColor(newInput.value);
        }
        menu.style.display = 'block';
        let left = event.pageX;
        let top = event.pageY;
        const menuRect = menu.getBoundingClientRect();
        const viewportWidth = window.innerWidth;
        const viewportHeight = window.innerHeight;
        if (left + menuRect.width > viewportWidth) {
            left = viewportWidth - menuRect.width - 10;
        }
        if (top + menuRect.height > viewportHeight + window.scrollY) {
            top = event.pageY - menuRect.height;
            if (top < window.scrollY) {
                top = window.scrollY + 10;
            }
        }
        menu.style.left = left + 'px';
        menu.style.top = top + 'px';
        setTimeout(() => {
            document.addEventListener('click', function closeMenu(e) {
                if (!menu.contains(e.target)) {
                    menu.style.display = 'none';
                    document.removeEventListener('click', closeMenu);
                }
            });
        }, 10);
    }

    function showTitleColorPicker(titleElement, boardId, event) {
        // Check if there's a text selection
        const selection = window.getSelection();
        const hasSelection = selection && selection.toString().trim().length > 0;

        activeCell = titleElement;
        const menu = createColorPickerMenu();
        const tabs = menu.querySelectorAll('.color-tab');
        tabs.forEach(tab => {
            tab.onclick = () => {
                tabs.forEach(t => t.classList.remove('active'));
                tab.classList.add('active');
                currentColorMode = tab.dataset.mode;
            };
        });
        const scopeBtns = menu.querySelectorAll('.scope-btn');
        scopeBtns.forEach(btn => btn.style.display = 'none');
        const glowToggle = menu.querySelector('#glowToggle');
        if (glowToggle) {
            glowToggle.checked = glowEnabled;
            glowToggle.onchange = () => { glowEnabled = glowToggle.checked; };
        }
        const rainbowToggle = menu.querySelector('#rainbowToggle');
        if (rainbowToggle) {
            rainbowToggle.checked = rainbowEnabled;
            rainbowToggle.onchange = () => {
                rainbowEnabled = rainbowToggle.checked;
                if (rainbowEnabled && rainbowStrokeEnabled) {
                    rainbowStrokeEnabled = false;
                    const strokeToggle = menu.querySelector('#rainbowStrokeToggle');
                    if (strokeToggle) strokeToggle.checked = false;
                }
            };
        }
        const rainbowStrokeToggle = menu.querySelector('#rainbowStrokeToggle');
        if (rainbowStrokeToggle) {
            rainbowStrokeToggle.checked = rainbowStrokeEnabled;
            rainbowStrokeToggle.onchange = () => {
                rainbowStrokeEnabled = rainbowStrokeToggle.checked;
                if (rainbowStrokeEnabled && rainbowEnabled) {
                    rainbowEnabled = false;
                    const fullToggle = menu.querySelector('#rainbowToggle');
                    if (fullToggle) fullToggle.checked = false;
                }
            };
        }
        function applyColor(colorValue) {
            // Apply to selected text only
            if (hasSelection) {
                const range = selection.getRangeAt(0);
                const span = document.createElement('span');

                if (currentColorMode === 'text') {
                    if (rainbowEnabled) {
                        span.className = 'rainbow-text';
                    } else if (rainbowStrokeEnabled) {
                        span.className = 'rainbow-stroke';
                    } else {
                        span.style.color = colorValue || '';
                        if (glowEnabled && colorValue) {
                            span.style.textShadow = `0 0 10px ${colorValue}, 0 0 20px ${colorValue}`;
                        }
                    }
                } else {
                    span.style.backgroundColor = colorValue || '';
                    if (glowEnabled && colorValue) {
                        span.style.boxShadow = `inset 0 0 20px ${colorValue}40, 0 0 10px ${colorValue}30`;
                    }
                }

                try {
                    range.surroundContents(span);
                } catch (e) {
                    const contents = range.extractContents();
                    span.appendChild(contents);
                    range.insertNode(span);
                }

                selection.removeAllRanges();
                menu.style.display = 'none';
                return;
            }

            // Apply to entire title
            const board = boards.find(b => b.id === boardId);
            if (board) {
                if (!board.titleColors) board.titleColors = {};
                titleElement.classList.remove('rainbow-text', 'rainbow-stroke');
                if (currentColorMode === 'text') {
                    if (rainbowEnabled) {
                        titleElement.classList.add('rainbow-text');
                        titleElement.style.color = '';
                        titleElement.style.textShadow = '';
                        board.titleColors.rainbow = true;
                        board.titleColors.rainbowStroke = false;
                        board.titleColors.color = '';
                    } else if (rainbowStrokeEnabled) {
                        titleElement.classList.add('rainbow-stroke');
                        titleElement.style.color = '';
                        titleElement.style.textShadow = '';
                        board.titleColors.rainbowStroke = true;
                        board.titleColors.rainbow = false;
                        board.titleColors.color = '';
                    } else {
                        titleElement.style.color = colorValue || '';
                        board.titleColors.color = colorValue;
                        board.titleColors.rainbow = false;
                        board.titleColors.rainbowStroke = false;
                        if (glowEnabled && colorValue) {
                            titleElement.style.textShadow = `0 0 10px ${colorValue}, 0 0 20px ${colorValue}`;
                        } else {
                            titleElement.style.textShadow = '';
                        }
                    }
                } else {
                    titleElement.style.backgroundColor = colorValue || '';
                    board.titleColors.bgColor = colorValue;
                    if (glowEnabled && colorValue) {
                        titleElement.style.boxShadow = `inset 0 0 20px ${colorValue}40, 0 0 10px ${colorValue}30`;
                    } else {
                        titleElement.style.boxShadow = '';
                    }
                }
                board.titleColors.glow = glowEnabled;
                saveToLocalStorage();
            }
            menu.style.display = 'none';
        }
        const buttons = menu.querySelectorAll('button[data-color-value]');
        buttons.forEach(btn => {
            const newBtn = btn.cloneNode(true);
            btn.parentNode.replaceChild(newBtn, btn);
            newBtn.onclick = () => {
                if (newBtn.dataset.clearAll === 'true') {
                    glowEnabled = false;
                    rainbowEnabled = false;
                    rainbowStrokeEnabled = false;
                    const glowToggle = menu.querySelector('#glowToggle');
                    const rainbowToggle = menu.querySelector('#rainbowToggle');
                    const rainbowStrokeToggle = menu.querySelector('#rainbowStrokeToggle');
                    if (glowToggle) glowToggle.checked = false;
                    if (rainbowToggle) rainbowToggle.checked = false;
                    if (rainbowStrokeToggle) rainbowStrokeToggle.checked = false;
                }
                applyColor(newBtn.dataset.colorValue);
                // Refresh table to apply changes immediately
                if (newBtn.dataset.clearAll === 'true') {
                    setTimeout(() => renderBoard(), 50);
                }
            };
            newBtn.onmouseenter = () => newBtn.style.transform = 'scale(1.1)';
            newBtn.onmouseleave = () => newBtn.style.transform = 'scale(1)';
        });
        const customInput = menu.querySelector('#customColorInput');
        if (customInput) {
            const newInput = customInput.cloneNode(true);
            customInput.parentNode.replaceChild(newInput, customInput);
            newInput.onchange = () => applyColor(newInput.value);
        }
        menu.style.display = 'block';
        let left = event.pageX;
        let top = event.pageY;
        const menuRect = menu.getBoundingClientRect();
        const viewportWidth = window.innerWidth;
        const viewportHeight = window.innerHeight;
        if (left + menuRect.width > viewportWidth) {
            left = viewportWidth - menuRect.width - 10;
        }
        if (top + menuRect.height > viewportHeight + window.scrollY) {
            top = event.pageY - menuRect.height;
            if (top < window.scrollY) {
                top = window.scrollY + 10;
            }
        }
        menu.style.left = left + 'px';
        menu.style.top = top + 'px';
        setTimeout(() => {
            document.addEventListener('click', function closeMenu(e) {
                if (!menu.contains(e.target)) {
                    menu.style.display = 'none';
                    document.removeEventListener('click', closeMenu);
                }
            });
        }, 10);
    }

    function showTagColorPicker(tagElement, boardId, tagIndex, event) {
        const menu = createColorPickerMenu();
        const tabs = menu.querySelectorAll('.color-tab');
        tabs.forEach(tab => {
            tab.onclick = () => {
                tabs.forEach(t => t.classList.remove('active'));
                tab.classList.add('active');
                currentColorMode = tab.dataset.mode;
            };
        });
        const scopeBtns = menu.querySelectorAll('.scope-btn');
        scopeBtns.forEach(btn => btn.style.display = 'none');
        const glowToggle = menu.querySelector('#glowToggle');
        if (glowToggle) glowToggle.style.display = 'none';
        const rainbowToggle = menu.querySelector('#rainbowToggle');
        if (rainbowToggle) rainbowToggle.style.display = 'none';
        const rainbowStrokeToggle = menu.querySelector('#rainbowStrokeToggle');
        if (rainbowStrokeToggle) rainbowStrokeToggle.style.display = 'none';

        function applyColor(colorValue) {
            const board = boards.find(b => b.id === boardId);
            if (board && board.tags[tagIndex]) {
                if (currentColorMode === 'text') {
                    board.tags[tagIndex].color = colorValue;
                    tagElement.style.color = colorValue;
                    tagElement.style.borderColor = `${colorValue}40`;
                } else {
                    board.tags[tagIndex].bgColor = colorValue;
                    tagElement.style.backgroundColor = colorValue;
                }
                saveToLocalStorage();
            }
            menu.style.display = 'none';
        }

        const buttons = menu.querySelectorAll('button[data-color-value]');
        buttons.forEach(btn => {
            const newBtn = btn.cloneNode(true);
            btn.parentNode.replaceChild(newBtn, btn);
            newBtn.onclick = () => applyColor(newBtn.dataset.colorValue);
            newBtn.onmouseenter = () => newBtn.style.transform = 'scale(1.1)';
            newBtn.onmouseleave = () => newBtn.style.transform = 'scale(1)';
        });
        const customInput = menu.querySelector('#customColorInput');
        if (customInput) {
            const newInput = customInput.cloneNode(true);
            customInput.parentNode.replaceChild(newInput, customInput);
            newInput.onchange = () => applyColor(newInput.value);
        }
        menu.style.display = 'block';
        let left = event.pageX;
        let top = event.pageY;
        const menuRect = menu.getBoundingClientRect();
        const viewportWidth = window.innerWidth;
        const viewportHeight = window.innerHeight;
        if (left + menuRect.width > viewportWidth) {
            left = viewportWidth - menuRect.width - 10;
        }
        if (top + menuRect.height > viewportHeight + window.scrollY) {
            top = event.pageY - menuRect.height;
            if (top < window.scrollY) {
                top = window.scrollY + 10;
            }
        }
        menu.style.left = left + 'px';
        menu.style.top = top + 'px';
        setTimeout(() => {
            document.addEventListener('click', function closeMenu(e) {
                if (!menu.contains(e.target)) {
                    menu.style.display = 'none';
                    document.removeEventListener('click', closeMenu);
                }
            });
        }, 10);
    }

    function saveState() {
        const state = {
            boards: JSON.parse(JSON.stringify(boards)),
            statusOptions: JSON.parse(JSON.stringify(statusOptions))
        };
        historyStack.push(state);
        if (historyStack.length > MAX_HISTORY) historyStack.shift();
        updateUndoButton();
    }

    function undo() {
        if (historyStack.length === 0) return;
        const prevState = historyStack.pop();
        boards = prevState.boards;
        statusOptions = prevState.statusOptions;
        saveToLocalStorage();
        renderBoard();
        updateUndoButton();
    }

    function updateUndoButton() {
        if (!undoBtn) return;
        undoBtn.disabled = historyStack.length === 0;
        undoBtn.style.opacity = historyStack.length === 0 ? '0.5' : '1';
        undoBtn.style.cursor = historyStack.length === 0 ? 'not-allowed' : 'pointer';
    }

    function saveToLocalStorage() {
        localStorage.setItem('boards', JSON.stringify(boards));
        localStorage.setItem('statusOptions', JSON.stringify(statusOptions));
        checkEmptyState();
        if (typeof saveToFirebase === 'function') {
            saveToFirebase();
        }
    }

    function checkEmptyState() {
        if (boards.length === 0) {
            emptyBoardState.classList.remove('hidden');
        } else {
            emptyBoardState.classList.add('hidden');
        }
    }

    function getStatusStyle(statusValue) {
        const status = statusOptions.find(s => s.value === statusValue);
        if (!status) return 'background-color: #374151; color: #e5e7eb;';
        return `background-color: ${status.color}20; color: ${status.color}; border: 1px solid ${status.color}40;`;
    }

    function renderBoard() {
        boardWrapper.innerHTML = '';
        boards.forEach(board => {
            const card = createTableCard(board);
            boardWrapper.appendChild(card);
        });
        checkEmptyState();
    }

    function createTableCard(board) {
        const card = document.createElement('div');
        card.className = 'table-card';
        card.dataset.boardId = board.id;

        if (board.hidden) {
            card.style.display = 'none';
        }

        const header = document.createElement('div');
        header.className = 'table-card-header';
        header.style.cssText = 'display: flex; align-items: center; justify-content: space-between; flex-wrap: wrap; gap: 12px;';

        const titleSection = document.createElement('div');
        titleSection.style.cssText = 'display: flex; align-items: center; gap: 8px; flex: 1; min-width: 200px; flex-wrap: wrap;';

        const title = document.createElement('h3');
        title.contentEditable = true;
        title.textContent = board.title;
        title.style.margin = '0';
        title.onfocus = () => saveState();
        title.onblur = () => {
            const newTitle = title.textContent.trim();
            if (newTitle && newTitle !== board.title) {
                board.title = newTitle;
                saveToLocalStorage();
            } else if (!newTitle) {
                title.textContent = board.title;
            }
        };
        title.onkeydown = (e) => {
            if (e.key === 'Enter') {
                e.preventDefault();
                title.blur();
            }
        };
        title.oncontextmenu = (e) => {
            if (e.ctrlKey) {
                e.preventDefault();
                e.stopPropagation();
                showTitleColorPicker(title, board.id, e);
            }
        };

        titleSection.appendChild(title);

        const tagsContainer = document.createElement('div');
        tagsContainer.style.cssText = 'display: flex; gap: 6px; align-items: center; flex-wrap: wrap;';

        if (!board.tags) board.tags = [];

        function renderTags() {
            tagsContainer.innerHTML = '';
            board.tags.forEach((tag, index) => {
                const tagEl = document.createElement('span');
                tagEl.contentEditable = true;
                tagEl.textContent = tag.text;
                tagEl.style.cssText = `padding: 6px 10px; border-radius: 4px; font-size: 0.875rem; font-weight: 600; background: ${tag.bgColor || 'rgba(59, 130, 246, 0.2)'}; color: ${tag.color || '#3b82f6'}; border: 1px solid ${tag.color || '#3b82f6'}40; cursor: pointer; white-space: nowrap; position: relative; padding-right: 28px; outline: none;`;

                tagEl.onfocus = () => saveState();
                tagEl.onblur = () => {
                    const newText = tagEl.textContent.trim();
                    if (newText) {
                        board.tags[index].text = newText;
                        saveToLocalStorage();
                    } else {
                        board.tags.splice(index, 1);
                        saveToLocalStorage();
                        renderTags();
                    }
                };

                tagEl.onkeydown = (e) => {
                    if (e.key === 'Enter') {
                        e.preventDefault();
                        tagEl.blur();
                    }
                };

                tagEl.oncontextmenu = (e) => {
                    if (e.ctrlKey) {
                        e.preventDefault();
                        e.stopPropagation();
                        showTagColorPicker(tagEl, board.id, index, e);
                    }
                };

                const deleteBtn = document.createElement('button');
                deleteBtn.innerHTML = '√ó';
                deleteBtn.style.cssText = 'position: absolute; right: 4px; top: 50%; transform: translateY(-50%); background: none; border: none; color: inherit; cursor: pointer; font-size: 1rem; line-height: 1; padding: 0 2px; opacity: 0.7;';
                deleteBtn.onmouseenter = () => deleteBtn.style.opacity = '1';
                deleteBtn.onmouseleave = () => deleteBtn.style.opacity = '0.7';
                deleteBtn.onclick = (e) => {
                    e.stopPropagation();
                    board.tags.splice(index, 1);
                    saveToLocalStorage();
                    renderTags();
                };

                tagEl.appendChild(deleteBtn);
                tagsContainer.appendChild(tagEl);
            });

            const addTagBtn = document.createElement('button');
            addTagBtn.innerHTML = '<i class="fa-solid fa-plus"></i> Tag';
            addTagBtn.style.cssText = 'padding: 4px 8px; border-radius: 4px; font-size: 0.75rem; background: var(--bg-color); color: var(--text-secondary); border: 1px dashed var(--border-color); cursor: pointer; white-space: nowrap;';
            addTagBtn.onclick = () => {
                board.tags.push({ text: 'New Tag', color: '#3b82f6', bgColor: 'rgba(59, 130, 246, 0.2)' });
                saveToLocalStorage();
                renderTags();
                setTimeout(() => {
                    const newTag = tagsContainer.children[board.tags.length - 1];
                    if (newTag && newTag.contentEditable === 'true') {
                        newTag.focus();
                        const range = document.createRange();
                        range.selectNodeContents(newTag);
                        const selection = window.getSelection();
                        selection.removeAllRanges();
                        selection.addRange(range);
                    }
                }, 10);
            };
            tagsContainer.appendChild(addTagBtn);
        }

        renderTags();
        titleSection.appendChild(tagsContainer);

        const btnGroup = document.createElement('div');
        btnGroup.style.cssText = 'display: flex; gap: 8px;';

        const hideBtn = document.createElement('button');
        hideBtn.className = 'btn-icon-sm';
        hideBtn.title = '‡∏ã‡πà‡∏≠‡∏ô‡∏ï‡∏≤‡∏£‡∏≤‡∏á';
        hideBtn.innerHTML = '<i class="fa-solid fa-eye-slash"></i>';
        hideBtn.onclick = () => toggleTableVisibility(board.id);

        const deleteBtn = document.createElement('button');
        deleteBtn.className = 'btn-icon-sm';
        deleteBtn.title = '‡∏•‡∏ö‡∏ï‡∏≤‡∏£‡∏≤‡∏á';
        deleteBtn.innerHTML = '<i class="fa-solid fa-trash"></i>';
        deleteBtn.onclick = () => deleteTable(board.id);

        btnGroup.appendChild(hideBtn);
        btnGroup.appendChild(deleteBtn);

        header.appendChild(titleSection);
        header.appendChild(btnGroup);

        const body = document.createElement('div');
        body.className = 'table-card-body';

        const table = document.createElement('table');
        const thead = document.createElement('thead');
        const headerRow = document.createElement('tr');
        const headers = ['No.', ...columns.map(c => c.label), '‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞', ''];
        const headerTypes = ['no', 'title', 'time', 'status', 'action'];
        const headerWidths = ['40px', '60%', '20%', '150px', '40px'];
        headers.forEach((h, i) => {
            const th = document.createElement('th');
            th.style.width = headerWidths[i];
            th.textContent = h;
            th.dataset.headerType = headerTypes[i];
            if (board.headerColors && board.headerColors[headerTypes[i]]) {
                const colors = board.headerColors[headerTypes[i]];
                if (colors.rainbow) {
                    th.classList.add('rainbow-text');
                } else if (colors.rainbowStroke) {
                    th.classList.add('rainbow-stroke');
                } else if (colors.color) {
                    th.style.color = colors.color;
                }
                if (colors.bgColor) {
                    th.style.backgroundColor = colors.bgColor;
                }
                if (colors.glow) {
                    if (colors.color && !colors.rainbow && !colors.rainbowStroke) {
                        th.style.textShadow = `0 0 10px ${colors.color}, 0 0 20px ${colors.color}`;
                    }
                    if (colors.bgColor) {
                        th.style.boxShadow = `inset 0 0 20px ${colors.bgColor}40, 0 0 10px ${colors.bgColor}30`;
                    }
                }
            }
            th.oncontextmenu = (e) => showColorPicker(th, e, false, true);
            headerRow.appendChild(th);
        });
        thead.appendChild(headerRow);
        table.appendChild(thead);
        const tbody = document.createElement('tbody');
        table.appendChild(tbody);
        renderRows(tbody, board.rows, board.id);
        body.appendChild(table);
        const footer = document.createElement('div');
        footer.className = 'table-card-footer';
        footer.innerHTML = `<div class="card-add-row"><input type="date" class="date-input" id="date-${board.id}"><input type="number" class="bulk-add-input" id="bulk-${board.id}" value="1" min="1" max="50" title="‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÅ‡∏ñ‡∏ß"><button class="btn-primary btn-sm" onclick="addBoardRows(${board.id})"><i class="fa-solid fa-plus"></i> ‡πÄ‡∏û‡∏¥‡πà‡∏°</button></div>`;
        const dateInput = footer.querySelector('.date-input');
        if (dateInput) {
            dateInput.valueAsDate = new Date();
        }
        card.append(header, body, footer);
        return card;
    }

    function toggleTableVisibility(boardId) {
        const board = boards.find(b => b.id === boardId);
        if (board) {
            board.hidden = !board.hidden;
            saveToLocalStorage();
            renderBoard();
        }
    }

    function renderRows(tbody, rows, boardId) {
        const sortedRows = [...rows].sort((a, b) => new Date(a.date) - new Date(b.date));
        const grouped = {};
        sortedRows.forEach(item => {
            const dateKey = item.date || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà';
            if (!grouped[dateKey]) grouped[dateKey] = [];
            grouped[dateKey].push(item);
        });
        let globalIndex = 1;
        Object.keys(grouped).forEach(date => {
            const dateRow = document.createElement('tr');
            const dateCell = document.createElement('td');
            dateCell.colSpan = 1 + columns.length + 2;
            dateCell.className = 'date-header';
            dateCell.style.cssText = 'cursor: pointer; user-select: none; position: relative;';
            dateCell.dataset.field = 'date-header';
            dateCell.dataset.date = date;
            const dateObj = new Date(date);
            const dateStr = isNaN(dateObj) ? date : dateObj.toLocaleDateString('th-TH', {
                weekday: 'short', day: 'numeric', month: 'short'
            });
            const toggleIcon = document.createElement('i');
            toggleIcon.className = 'fa-solid fa-chevron-down';
            toggleIcon.style.cssText = 'margin-right: 8px; transition: transform 0.2s;';
            const calendarIcon = document.createElement('i');
            calendarIcon.className = 'fa-regular fa-calendar';
            calendarIcon.style.marginRight = '8px';
            const dateText = document.createTextNode(` ${dateStr}`);
            dateCell.appendChild(toggleIcon);
            dateCell.appendChild(calendarIcon);
            dateCell.appendChild(dateText);
            const board = boards.find(b => b.id === boardId);
            if (board && board.dateColors && board.dateColors[date]) {
                const colors = board.dateColors[date];
                if (colors.rainbow) {
                    dateCell.classList.add('rainbow-text');
                } else if (colors.rainbowStroke) {
                    dateCell.classList.add('rainbow-stroke');
                } else if (colors.color) {
                    dateCell.style.color = colors.color;
                }
                if (colors.bgColor) {
                    dateCell.style.backgroundColor = colors.bgColor;
                }
                if (colors.glow) {
                    if (colors.color && !colors.rainbow && !colors.rainbowStroke) {
                        dateCell.style.textShadow = `0 0 10px ${colors.color}, 0 0 20px ${colors.color}`;
                    }
                    if (colors.bgColor) {
                        dateCell.style.boxShadow = `inset 0 0 20px ${colors.bgColor}40, 0 0 10px ${colors.bgColor}30`;
                    }
                }
            }
            dateCell.oncontextmenu = (e) => showColorPicker(dateCell, e, true, false);
            dateRow.appendChild(dateCell);
            tbody.appendChild(dateRow);
            const dateGroupRows = [];
            let dateIndex = 1;
            grouped[date].forEach(item => {
                const tr = document.createElement('tr');
                tr.dataset.id = item.id;
                tr.className = 'date-group-row';
                tr.innerHTML = `<td>${dateIndex++}</td>`;
                columns.forEach(col => {
                    const td = document.createElement('td');
                    td.dataset.field = col.id;
                    if (col.id === 'time') {
                        td.contentEditable = false;
                        td.textContent = item[col.id] || '';
                        td.style.textAlign = 'center';
                        td.style.fontFamily = 'monospace';
                        td.style.fontSize = 'var(--font-size-base)';
                        td.style.fontWeight = '500';
                    } else if (col.id === 'title') {
                        td.style.position = 'relative';
                        td.style.padding = '8px 40px 8px 8px';
                        const contentDiv = document.createElement('div');
                        contentDiv.contentEditable = true;
                        contentDiv.className = 'editable';
                        contentDiv.textContent = item[col.id] || '';
                        contentDiv.style.cssText = 'outline: none; min-height: 20px;';
                        contentDiv.onfocus = () => saveState();
                        contentDiv.onblur = () => {
                            let value = contentDiv.textContent.trim();
                            updateItem(boardId, item.id, col.id, value);
                            if (autoTimestampEnabled) {
                                const timeCell = td.parentElement.querySelector('[data-field="time"]');
                                if (timeCell) {
                                    if (value) {
                                        const newTime = getCurrentTime();
                                        timeCell.textContent = newTime;
                                        updateItem(boardId, item.id, 'time', newTime);
                                    } else {
                                        timeCell.textContent = '';
                                        updateItem(boardId, item.id, 'time', '');
                                    }
                                }
                            }
                        };
                        const copyBtn = document.createElement('button');
                        copyBtn.innerHTML = '<i class="fa-regular fa-copy"></i>';
                        copyBtn.className = 'copy-btn';
                        copyBtn.style.cssText = `position: absolute; right: 8px; top: 50%; transform: translateY(-50%); background: var(--primary-color); color: white; border: none; border-radius: 4px; padding: 4px 8px; cursor: pointer; opacity: 0.7; transition: opacity 0.2s; font-size: 0.85rem;`;
                        copyBtn.title = '‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°';
                        copyBtn.onclick = (e) => {
                            e.stopPropagation();
                            const text = contentDiv.textContent;
                            navigator.clipboard.writeText(text).then(() => {
                                copyBtn.innerHTML = '<i class="fa-solid fa-check"></i>';
                                copyBtn.style.background = '#10b981';
                                setTimeout(() => {
                                    copyBtn.innerHTML = '<i class="fa-regular fa-copy"></i>';
                                    copyBtn.style.background = 'var(--primary-color)';
                                }, 1000);
                            });
                        };
                        copyBtn.onmouseenter = () => copyBtn.style.opacity = '1';
                        copyBtn.onmouseleave = () => copyBtn.style.opacity = '0.7';
                        td.appendChild(contentDiv);
                        td.appendChild(copyBtn);
                    } else {
                        td.contentEditable = true;
                        td.className = 'editable';
                        td.textContent = item[col.id] || '';
                        td.onfocus = () => saveState();
                        td.onblur = () => {
                            let value = td.textContent.trim();
                            updateItem(boardId, item.id, col.id, value);
                            if (autoTimestampEnabled) {
                                const timeCell = td.parentElement.querySelector('[data-field="time"]');
                                if (timeCell) {
                                    if (value) {
                                        const newTime = getCurrentTime();
                                        timeCell.textContent = newTime;
                                        updateItem(boardId, item.id, 'time', newTime);
                                    } else {
                                        timeCell.textContent = '';
                                        updateItem(boardId, item.id, 'time', '');
                                    }
                                }
                            }
                        };
                    }
                    const target = td.querySelector('.editable') || td;
                    if (item.cellRainbow && item.cellRainbow[col.id]) {
                        target.classList.add('rainbow-text');
                    } else if (item.cellRainbowStroke && item.cellRainbowStroke[col.id]) {
                        target.classList.add('rainbow-stroke');
                    } else {
                        if (item.cellColors && item.cellColors[col.id]) {
                            target.style.color = item.cellColors[col.id];
                        }
                    }
                    if (item.cellBgColors && item.cellBgColors[col.id]) {
                        target.style.backgroundColor = item.cellBgColors[col.id];
                    }
                    if (item.cellGlow && item.cellGlow[col.id]) {
                        if (item.cellColors && item.cellColors[col.id] && !item.cellRainbow[col.id] && !item.cellRainbowStroke[col.id]) {
                            target.style.textShadow = `0 0 10px ${item.cellColors[col.id]}, 0 0 20px ${item.cellColors[col.id]}`;
                        }
                        if (item.cellBgColors && item.cellBgColors[col.id]) {
                            target.style.boxShadow = `inset 0 0 20px ${item.cellBgColors[col.id]}40, 0 0 10px ${item.cellBgColors[col.id]}30`;
                        }
                    }
                    td.oncontextmenu = (e) => showColorPicker(td, e, false, false);
                    tr.appendChild(td);
                });
                const tdStatus = document.createElement('td');
                const select = document.createElement('select');
                select.className = 'status-select';
                select.style = getStatusStyle(item.status);
                statusOptions.forEach(opt => {
                    const option = document.createElement('option');
                    option.value = opt.value;
                    option.textContent = opt.label;
                    if (opt.value === item.status) option.selected = true;
                    select.appendChild(option);
                });
                select.onfocus = () => saveState();
                select.onchange = (e) => {
                    updateItem(boardId, item.id, 'status', e.target.value);
                    select.style = getStatusStyle(e.target.value);
                };
                tdStatus.appendChild(select);
                tr.appendChild(tdStatus);
                const tdAction = document.createElement('td');
                tdAction.innerHTML = `<button class="btn-delete" onclick="deleteRow(${boardId}, ${item.id})"><i class="fa-regular fa-trash-can"></i></button>`;
                tr.appendChild(tdAction);
                dateGroupRows.push(tr);
                tbody.appendChild(tr);
            });
            dateCell.onclick = (e) => {
                if (!e.ctrlKey) {
                    const isHidden = dateGroupRows[0].style.display === 'none';
                    dateGroupRows.forEach(row => {
                        row.style.display = isHidden ? '' : 'none';
                    });
                    toggleIcon.style.transform = isHidden ? 'rotate(0deg)' : 'rotate(-90deg)';
                }
            };
        });
    }

    window.addBoardRows = (boardId) => {
        saveState();
        const board = boards.find(b => b.id === boardId);
        const dateInput = document.getElementById(`date-${boardId}`);
        const bulkInput = document.getElementById(`bulk-${boardId}`);
        const count = parseInt(bulkInput.value) || 1;
        if (board && dateInput) {
            for (let i = 0; i < count; i++) {
                const newItem = {
                    id: Date.now() + i,
                    title: '',
                    time: '',
                    status: statusOptions[0].value,
                    date: dateInput.value,
                    cellColors: {},
                    cellBgColors: {},
                    cellGlow: {},
                    cellRainbow: {},
                    cellRainbowStroke: {}
                };
                board.rows.push(newItem);
            }
            saveToLocalStorage();
            renderBoard();
        }
    };

    window.updateItem = (boardId, itemId, field, value) => {
        const board = boards.find(b => b.id === boardId);
        if (board) {
            const item = board.rows.find(r => r.id === itemId);
            if (item && item[field] !== value) {
                item[field] = value;
                saveToLocalStorage();
            }
        }
    };

    window.deleteRow = (boardId, itemId) => {
        if (confirm('‡∏•‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ô‡∏µ‡πâ?')) {
            saveState();
            const board = boards.find(b => b.id === boardId);
            if (board) {
                board.rows = board.rows.filter(r => r.id !== itemId);
                saveToLocalStorage();
                renderBoard();
            }
        }
    };

    window.deleteTable = (boardId) => {
        if (confirm('‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏ô‡∏µ‡πâ‡πÅ‡∏•‡∏∞‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î?')) {
            saveState();
            boards = boards.filter(b => b.id !== boardId);
            saveToLocalStorage();
            renderBoard();
        }
    };

    addTableBtn.onclick = () => {
        newTableNameInput.value = '';
        addTableModal.classList.remove('hidden');
        newTableNameInput.focus();
    };

    closeTableModalBtn.onclick = () => addTableModal.classList.add('hidden');

    confirmAddTableBtn.onclick = () => {
        const title = newTableNameInput.value.trim();
        if (title) {
            saveState();
            boards.push({
                id: Date.now(),
                title: title,
                rows: [],
                hidden: false
            });
            saveToLocalStorage();
            renderBoard();
            addTableModal.classList.add('hidden');
        }
    };

    settingsBtn.onclick = () => {
        renderStatusList();
        settingsModal.classList.remove('hidden');
    };

    closeModalBtn.onclick = () => settingsModal.classList.add('hidden');

    function renderStatusList() {
        statusList.innerHTML = '';
        statusOptions.forEach((status, index) => {
            const item = document.createElement('div');
            item.className = 'status-item';
            item.innerHTML = `<div class="status-color-preview" style="background-color: ${status.color}"></div><input type="text" class="input-sm" value="${status.label}" onchange="updateStatusLabel(${index}, this.value)"><input type="color" class="color-input" value="${status.color}" onchange="updateStatusColor(${index}, this.value)"><button class="btn-delete" onclick="deleteStatus(${index})"><i class="fa-solid fa-xmark"></i></button>`;
            statusList.appendChild(item);
        });
    }

    window.updateStatusLabel = (index, val) => {
        saveState();
        statusOptions[index].label = val;
        saveToLocalStorage();
        renderBoard();
    };

    window.updateStatusColor = (index, val) => {
        saveState();
        statusOptions[index].color = val;
        saveToLocalStorage();
        renderBoard();
    };

    window.deleteStatus = (index) => {
        if (statusOptions.length <= 1) return alert('‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏µ‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢ 1 ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞');
        if (confirm('‡∏•‡∏ö‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏ô‡∏µ‡πâ?')) {
            saveState();
            statusOptions.splice(index, 1);
            saveToLocalStorage();
            renderStatusList();
            renderBoard();
        }
    };

    addStatusBtn.onclick = () => {
        const label = newStatusLabel.value.trim();
        if (label) {
            saveState();
            statusOptions.push({
                id: 's' + Date.now(),
                value: 's' + Date.now(),
                label: label,
                color: newStatusColor.value
            });
            newStatusLabel.value = '';
            saveToLocalStorage();
            renderStatusList();
            renderBoard();
        }
    };

    toggleTimestampBtn.onclick = () => {
        autoTimestampEnabled = !autoTimestampEnabled;
        localStorage.setItem('autoTimestampEnabled', autoTimestampEnabled);
        updateTimestampButton();
    };

    fontIncreaseBtn.onclick = increaseFontSize;
    fontDecreaseBtn.onclick = decreaseFontSize;
    themeToggleBtn.onclick = toggleTheme;

    showHiddenBtn.onclick = () => {
        renderHiddenTablesList();
        hiddenTablesModal.classList.remove('hidden');
    };

    closeHiddenModalBtn.onclick = () => hiddenTablesModal.classList.add('hidden');

    function renderHiddenTablesList() {
        const hiddenBoards = boards.filter(b => b.hidden);
        if (hiddenBoards.length === 0) {
            hiddenTablesList.innerHTML = '<p style="text-align: center; color: var(--text-secondary); padding: 20px;">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏ó‡∏µ‡πà‡∏ã‡πà‡∏≠‡∏ô‡πÑ‡∏ß‡πâ</p>';
            return;
        }
        hiddenTablesList.innerHTML = '';
        hiddenBoards.forEach(board => {
            const item = document.createElement('div');
            item.style.cssText = 'display: flex; justify-content: space-between; align-items: center; padding: 12px; background: var(--bg-color); border-radius: 6px; margin-bottom: 8px;';
            const titleSpan = document.createElement('span');
            titleSpan.textContent = board.title;
            titleSpan.style.cssText = 'font-weight: 500;';
            const showBtn = document.createElement('button');
            showBtn.className = 'btn-primary btn-sm';
            showBtn.innerHTML = '<i class="fa-solid fa-eye"></i> ‡πÅ‡∏™‡∏î‡∏á';
            showBtn.onclick = () => {
                board.hidden = false;
                saveToLocalStorage();
                renderBoard();
                renderHiddenTablesList();
            };
            item.appendChild(titleSpan);
            item.appendChild(showBtn);
            hiddenTablesList.appendChild(item);
        });
    }

    window.onclick = (e) => {
        if (e.target === settingsModal) settingsModal.classList.add('hidden');
        if (e.target === addTableModal) addTableModal.classList.add('hidden');
        if (e.target === hiddenTablesModal) hiddenTablesModal.classList.add('hidden');
    };

    if (undoBtn) undoBtn.addEventListener('click', undo);
    if (saveJsonBtn) saveJsonBtn.addEventListener('click', saveAsJson);
    if (exportExcelBtn) exportExcelBtn.addEventListener('click', exportToExcel);

    updateTimestampButton();
    updateFontSize();
    updateTheme();
    renderBoard();
    updateUndoButton();
    initFirebase();
    initFirebaseSync();
});

</script>
</body>

</html>